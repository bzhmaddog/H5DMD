<!DOCTYPE html>
<html>
    <head>
        <meta httpEquiv="origin-trial" content="AkfwxtdOv8lmILy1N481kK//CxRGUt8ZVnkI1Ef594MR9ZuWXiEG+nMchAsePoS/4CcSpqYhu+kQFyYXku4ZpAEAAABTeyJvcmlnaW4iOiJodHRwczovL2J6aG1hZGRvZy5naXRodWIuaW86NDQzIiwiZmVhdHVyZSI6IldlYkdQVSIsImV4cGlyeSI6MTY5MTcxMTk5OX0=" />

        <style>
            * {
	            box-sizing: border-box;
            }
            body {
                background:  black;
                padding: 0;
                margin: 0;
                overflow: hidden;
            }

            span, li, label {
                color: white;
            }

            /*#output {
                border: 1px solid red;
            }*/
        </style>
    </head>
    <body>
        <canvas id="output" width="1280" height="390"></canvas>
        <br />
        <div id="checkboxes">
            <div>
                <input id="background_checkbox" type="checkbox" data-layer="bg" checked />
                <label for="background_checkbox">Background</label>
            </div>
            <div>
                <input id="sprite_checkbox" type="checkbox" data-layer="sprite" checked />
                <label for="sprite_checkbox">Sprite</label>
            </div>
            <div>
                <input id="animation_checkbox" type="checkbox" data-layer="animation" checked />
                <label for="animation_checkbox">background animation</label>
            </div>
            <div>
                <input id="video_checkbox" type="checkbox" data-layer="video" />
                <label for="video_checkbox">Transparent video</label>
            </div>
            <div>
                <input id="vstext_checkbox" type="checkbox" data-layer="text2" checked />
                <label for="vstext_checkbox">VS text inner</label>
            </div>
            <div>
                <input id="vstext_checkbox2" type="checkbox" data-layer="text3" checked />
                <label for="vstext_checkbox2">VS text outer</label>
            </div>
            <div>
                <input id="scotttext_checkbox" type="checkbox" data-layer="text1" checked/>
                <label for="scotttext_checkbox">Scott pilgrim text</label>
            </div>
            <div>
                <input id="matthewtext_checkbox" type="checkbox" data-layer="text4" checked />
                <label for="matthewtext_checkbox">Matthew Patel text</label>
            </div>
            <div>
                <input id="matthewimg_checkbox" type="checkbox" data-layer="canvas" checked />
                <label for="matthewimg_checkbox">Matthew Patel Image</label>
            </div>
        </div>
		<div style="margin-top:20px">
            <span>Note (2023/02/18) : This demo have been tested  working on the following browsers :</span>
            <ul>
                <li>Windows: Chromium 105, 107, 110</li>
                <li>ArchLinux: Chromium 109 (google-chrome-dev 109.0.5414.10-1)</li>
                <li>MacOs: Chrome Canary (TBD)</li>
            </ul>
        </div>
        <script type="module">
			import { DMD } from "./js/DMD.js";
			import { Colors } from "./js/Colors.js";
			import { DotShape } from "./js/renderers/DMDRenderer.js";
            import { NoiseEffectRenderer } from "./js/renderers/NoiseEffectRenderer.js";
			import { Options } from "./js/Options.js";
            import { Utils } from "./js/Utils.js";
		
            (function () {
                'use strict';
				
				// Fix base uri when runing demo in nested path
				var base = document.createElement('base');
				base.href = document.location.href.replace("/Demo.html", "");
				document.getElementsByTagName('head')[0].appendChild(base);
				

                // When dom is loaded create the objects and bind the events
                document.addEventListener('DOMContentLoaded', function () {

		            // Check if webgpu is supported
                    if ("gpu" in navigator) {

                        var output = document.getElementById('output');
                        var dmd = new DMD(output, 2, 1, 1, 1, DotShape.Square, 14, 1, true);


                        var noises = [];
                        for (var i = 0 ; i < 6 ; i++) {
                            noises.push(`${document.baseURI}/images/noises/noise-${i}.png`);
                        }

                        var scoreRenderer = new NoiseEffectRenderer(dmd.width, dmd.height, 200, noises);

                        dmd.addRenderer('score-effect', scoreRenderer);


                        window.dmd = dmd;

                        // Init DMD then
                        dmd.init().then( () => {
                            // Start rendering dmd
                            dmd.run();

                            

                            var bgLayer = dmd.createCanvasLayer( 'bg', {}, (layer) => {
                                
                                var bgURI = document.baseURI + "/images/boss-mode-bg.png";
                                
                                fetch(bgURI)
                                .then(response => response.blob())
                                .then(blob => createImageBitmap(blob))
                                .then( bitmap => {
                                    layer.drawImage(bitmap, {
                                        width: 426,
                                        height: 130
                                    });
                                });
                                
                            });


                            dmd.createAnimationLayer( 'animation', {
                                duration : 800,
                                autoplay : true,
                                loop : true
                            }, layer => {

                                    var images =  [
                                        document.baseURI + '/images/animation/0.webp',
                                        document.baseURI + '/images/animation/1.webp',
                                        document.baseURI + '/images/animation/2.webp',
                                        document.baseURI + '/images/animation/3.webp',
                                        document.baseURI + '/images/animation/4.webp',
                                        document.baseURI + '/images/animation/5.webp',
                                        document.baseURI + '/images/animation/6.webp',
                                        document.baseURI + '/images/animation/7.webp',
                                        document.baseURI + '/images/animation/8.webp',
                                        document.baseURI + '/images/animation/9.webp',
                                        document.baseURI + '/images/animation/10.webp',
                                        document.baseURI + '/images/animation/11.webp',
                                        document.baseURI + '/images/animation/12.webp',
                                        document.baseURI + '/images/animation/13.webp',
                                        document.baseURI + '/images/animation/14.webp'
                                    ];

                                    Utils.loadImagesOrdered(images)
                                    .then(bitmaps => {
                                        layer.setAnimationData(bitmaps);
                                    });

                            });

                            var videoLayer = dmd.createVideoLayer('video', {
                                autoplay : true,
                                width : 426,
                                height : 130,
                                loop : true,
                                stopOnHide : true,
                                visible: false
                            }, (layer) => {
                                
                                const video = document.createElement('video');
                                
                                video.addEventListener('loadeddata', function () {
                                    layer.setVideo(video); // autoplay = true so no need to call play here
                                });

                                video.src = document.baseURI + '/images/transparent-video.webm';
                            });



                            var matthewLayer = dmd.createCanvasLayer('canvas', {
                                opacity : 1
                            }, function() {

                                var bgURI = document.baseURI + "/images/boss-matthew-big.png";
                                
                                fetch(bgURI)
                                .then(response => response.blob())
                                .then(blob => createImageBitmap(blob))
                                .then(bitmap => {
                                    matthewLayer.drawImage(
                                        bitmap,
                                        {
                                            align: 'right',
                                            vAlign : 'middle',
                                            height : '70%'
                                        }
                                    );
                                });
                            });
                            
                            var textLayer1 = dmd.createTextLayer('text1', {
                                text : "Scott Pilgrim",
                                left : '0',
                                top : 0,
                                fontSize : 10
                            });

                            var textLayer2 = dmd.createTextLayer('text2', {
                                text : "VS",
                                align : 'center',
                                vAlign : 'middle',
                                fontFamily : 'Arial',
                                fontSize : 40,
                                fontStyle : 'italic bold',
                                color : '#FFFFFF80', // RGBA
                                hOffset : '-15%',
                                renderers: ["score-effect"]
                            });

                            var textLayer3 = dmd.createTextLayer('text3', {
                                text : "VS",
                                align : 'center',
                                vAlign : 'middle',
                                fontFamily : 'Arial',
                                fontSize : 40,
                                fontStyle : 'italic bold',
                                color : '#00000000', // inner color totaly transparent to create an hollow text
                                strokeWidth : 2,
                                strokeColor : Colors.Red,
                                hOffset : '-15%',
                            });

                            var textLayer4 = dmd.createTextLayer('text4', {
                                text : "Matthew Patel",
                                align : 'right',
                                vAlign : 'bottom',
                                fontSize : 10,
                                hOffset : -1
                            });

                            var spriteLayer = dmd.createSpriteLayer('sprite', {}, (layer) => {

                                var bgURI = document.baseURI + "/images/scott2x.png";
                                
                                fetch(bgURI)
                                .then(response => response.blob())
                                .then(blob => createImageBitmap(blob))
                                .then(bitmap => {

                                    layer.createSprite(
                                        'scott',
                                        bitmap,
                                        6,
                                        0,
                                        [
                                            ['idle', 8, 72, 118, 0, 0, 900], //800
                                            ['walk', 6, 72, 126, 0, 118, 1100],
                                            ['run', 8, 106, 120, 0, 244, 650],
                                            ['idle2', 4, 92, 124, 0, 364, 900],
                                            ['taunt', 9, 92, 124, 0, 488, 450]
                                        ],
                                        '2%',
                                        '2%'
                                    ).then(() => {
                                        let seq = [
                                                    ['idle' , 3],
                                                    ['walk' , 5],
                                                    ['run', 4],
                                                    ['taunt', 1]
                                                    //['idle2', 1]
                                                ];

                                        layer.enqueueSequence('scott', seq, true);
                                        layer.run('scott');
                                    });

                                });

                            });


                            /*var l = dmd.createTextLayer(
                                'score',
                                new Options({
                                    text : "0123456789",
                                    //text : "0",
                                    fontSize : 40,
                                    fontFamily : 'Arial',
                                    align : 'right',
                                    hOffset : -1,
                                    vAlign : 'middle',
                                    color : Colors.White,
                                    outlineWidth : 2,
                                    outlineColor : Colors.Blue,
                                    adjustWidth : true,
                                    zIndex : 1000,
                                    aaTreshold : 144,
                                    antialiasing : false,
                                    visible : false,
                                    groups: ['hud'],
                                    renderers : ['score-effect']
                                })
                            );	

                            setTimeout( function() {
                                //console.log('here');
                                dmd.setLayerVisibility('score', true);
                            }, 5000);*/


                            /*var bgLayer = dmd.createCanvasLayer( 'test', {}, (layer) => {
                                
                                var bgURI = document.baseURI + "/images/hsupw.png";
                                
                                fetch(bgURI)
                                .then(response => response.blob())
                                .then(blob => createImageBitmap(blob))
                                .then( bitmap => {
                                    layer.drawImage(bitmap, {
                                        left: '50%',
                                        height: '80%'
                                    });
                                });
                                
                            });*/

                            var checkboxElems = document.querySelectorAll("input[type='checkbox']");

                            for (var i = 0; i < checkboxElems.length; i++) {
                                checkboxElems[i].addEventListener("click", function(element) {
                                    var layerName = element.target.dataset.layer;
                                    var visible = element.target.checked
                                    var layer = dmd.getLayer(layerName);

                                    if (layer != null) {
                                        layer.setVisibility(visible);

                                        if (visible) {
                                            if (layerName === "sprite") {
                                                layer.run('scott');
                                            }
                                        }
                                    
                                    } else {
                                        console.log(`Layer not found : ${layerName}`);
                                    }
                                });
                            }

                        }); // DMD.init()
		
                    } else {
                        alert('Sorry your browser does not support WEBGPU (or the feature is not enabled)');
                    }	
                },false); // DOM loaded
            })(); // Main
        </script>
    </body>
</html>