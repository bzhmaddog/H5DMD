<!DOCTYPE html> 
<title>Video/Canvas Demo 2</title> 
<script>

var bgImage = new Image(),
	dmd = {
		width : 1280,
		height : 248,
		canvas : undefined,
		context : undefined
	},
	Buffer = function (width, height) {
		var _canvas = document.createElement('canvas'),
			_context = _canvas.getContext('2d');
		
		_canvas.width = width;
		_canvas.height = height;
		
		return {
			width : width,
			height : height,
			canvas : _canvas,
			context : _context
		}
	},
	Pixel = {
		width : 3,
		height : 3
	},
	Video = {
		width : 320,
		height : 62
	},
	video,
	dmdBuffer,
	videoBuffer;
	//pixMap = buildPixelMapData();


	document.addEventListener('DOMContentLoaded', function () {
	
		bgImage.src = 'img/dmd3x3bg.png';
	
		video = document.getElementById('v');
	
		dmdBuffer = new Buffer(dmd.width, dmd.height);
		videoBuffer = new Buffer(Video.width, Video.height);
	
		dmd.canvas = document.getElementById('c');
		dmd.context = dmd.canvas.getContext('2d');
		
		dmd.canvas.width = dmd.width;
		dmd.canvas.height = dmd.height;

	video.addEventListener('play', function(){
		renderFrame();
	},false);
	
	console.log(dmdBuffer);
	
},false);
 
function getResizedPixelIndex(x, y) {
	var idx = (x - 1) * 12 + (x - 1) * 4 + (y - 1) * 1280 * 4 * 4 ;
	return  idx;
} 
 
function renderFrame() {
	if(video.paused || video.ended) {
		return false;
	}
	
	var frame = video;
	
	// draw the background image in the buffering canvas
	dmdBuffer.context.drawImage(bgImage,0,0,dmdBuffer.width, dmdBuffer.height);

	// draw the current video image in the frame buffer
	videoBuffer.context.drawImage(frame, 0, 0, Video.width, Video.height);
	//dmdBuffer.context.drawImage(frame, 0, 0, Video.width, Video.height);
	
	// Grab the pixel data from the backing canvas
	var backImageData = dmdBuffer.context.getImageData(0,0, dmdBuffer.width, dmdBuffer.height);
	var backData = backImageData.data;
	
	var frameImageData = videoBuffer.context.getImageData(0, 0,Video.width, Video.height);
	var frameData = frameImageData.data;

	// Loop through the pixels, turning them grayscale
	var p = 0;
	
	var x = 1;
	var y = 1;
	
	for (var i = 0 ; i < 320*62*4 ; i+=4) { // each pixel use 4 bytes (RGBA)
	//for (var i = 0 ; i < 1280*2 ; i+=4) { // each pixel use 4 bytes (RGBA)
		
		// get the pixel from the current frame
		var r = frameData[i];
		var g = frameData[i+1];
		var b = frameData[i+2];
		var a = frameData[i+3];

		// get the data index for this pixel in the DMD
		// use mapping to get fast results
		var pIndex = getResizedPixelIndex(x, y);
		
		//console.log(pIndex);

		/*r = 255;
		g = 0;
		b = 0;
		a = 255;*/
		
		for (var row = 0 ; row < 3 ; row++) {
			for(var col = 0 ; col < 3 ; col++) {
				backData[pIndex] = r;
				backData[pIndex+1] = g;
				backData[pIndex+2] = b;
				backData[pIndex+3] = a;
				
				pIndex += 4;
			}
			pIndex += 1280 * 4 - 12;
		}
		p++;

		x++;
	
		if (x > Video.width) {
			x = 1;
			y++;
		}
	}
	
	backImageData.data = backData;
	
	dmd.context.putImageData(backImageData, 0, 0);
	

	// Start over!
	setTimeout(renderFrame,10);
}
</script> 
 

 
<video id="v" controls loop> 
	<source src="medias/test2.webm" type="video/webm"> 
</video> 
<canvas id="c"></canvas> 
<style> 
body {
	background: #000;
}
#c {
	position: absolute;
	top: 0;
	left: 0;
}

#c2 {
	position: absolute;
	left: 0;
	top: 250px;
	width: 320px;
	height: 62px;
} 
 
 
#v {
	position: absolute;
	top: 350px;
	left: 0;
}
</style>